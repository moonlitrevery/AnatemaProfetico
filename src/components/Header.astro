---
---

<section class="sheet-section header-section">
  <h2 class="section-title">
    <span class="section-title-text">InformaÃ§Ãµes do personagem</span>
    <span class="section-title-decoration"></span>
  </h2>
  <div class="header-grid">
    <div class="header-item">
      <div class="header-item-label-row">
        <label for="vida-current">Vida</label>
        <div class="bonus-inputs-row">
          <div class="bonus-input-group">
            <label class="bonus-input-label" for="vida-temp">BÃ´nus de NÃ­vel</label>
            <input type="number" id="vida-temp" name="vida-temp" class="temp-value-small" placeholder="0" min="0" readonly title="BÃ´nus de nÃ­vel Ã  Vida MÃ¡xima" aria-label="Vida - BÃ´nus de NÃ­vel" />
          </div>
          <div class="bonus-input-group">
            <label class="bonus-input-label" for="vida-extra">BÃ´nus Extra</label>
            <input type="number" id="vida-extra" name="vida-extra" class="temp-value-small extra" placeholder="0" min="0" title="BÃ´nus extra Ã  Vida MÃ¡xima" aria-label="Vida - BÃ´nus Extra" />
          </div>
        </div>
      </div>
      <div class="hp-mana-container">
        <input type="number" id="vida-current" name="vida-current" class="current-value" placeholder="0" min="0" aria-label="Vida atual" />
        <span class="separator">/</span>
        <input type="number" id="vida-max" name="vida-max" readonly class="max-value" aria-label="Vida mÃ¡xima" />
      </div>
      <div class="stat-progress-bar" role="progressbar" aria-label="Progresso de Vida" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="stat-progress-fill stat-progress-vida" id="vida-progress-fill"></div>
      </div>
    </div>
    <div class="header-item">
      <div class="header-item-label-row">
        <label for="mana-current">Mana</label>
        <div class="bonus-inputs-row">
          <div class="bonus-input-group">
            <label class="bonus-input-label" for="mana-temp">BÃ´nus de NÃ­vel</label>
            <input type="number" id="mana-temp" name="mana-temp" class="temp-value-small" placeholder="0" min="0" readonly title="BÃ´nus de nÃ­vel Ã  Mana MÃ¡xima" aria-label="Mana - BÃ´nus de NÃ­vel" />
          </div>
          <div class="bonus-input-group">
            <label class="bonus-input-label" for="mana-extra">BÃ´nus Extra</label>
            <input type="number" id="mana-extra" name="mana-extra" class="temp-value-small extra" placeholder="0" min="0" title="BÃ´nus extra Ã  Mana MÃ¡xima" aria-label="Mana - BÃ´nus Extra" />
          </div>
        </div>
      </div>
      <div class="hp-mana-container">
        <input type="number" id="mana-current" name="mana-current" class="current-value" placeholder="0" min="0" aria-label="Mana atual" />
        <span class="separator">/</span>
        <input type="number" id="mana-max" name="mana-max" readonly class="max-value" aria-label="Mana mÃ¡xima" />
      </div>
      <div class="stat-progress-bar" role="progressbar" aria-label="Progresso de Mana" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="stat-progress-fill stat-progress-mana" id="mana-progress-fill"></div>
      </div>
    </div>
    <div class="header-item sanity-item">
      <div class="header-item-label-row">
        <label for="sanidade-current">Sanidade</label>
        <div class="bonus-inputs-row">
          <div class="bonus-input-group">
            <label class="bonus-input-label" for="sanidade-temp">BÃ´nus de NÃ­vel</label>
            <input type="number" id="sanidade-temp" name="sanidade-temp" class="temp-value-small" placeholder="0" min="0" readonly aria-label="Sanidade - BÃ´nus de NÃ­vel" title="BÃ´nus de nÃ­vel Ã  Sanidade MÃ¡xima" />
          </div>
          <div class="bonus-input-group">
            <label class="bonus-input-label" for="sanidade-extra">BÃ´nus Extra</label>
            <input type="number" id="sanidade-extra" name="sanidade-extra" class="temp-value-small extra" placeholder="0" min="0" aria-label="Sanidade - BÃ´nus Extra" title="BÃ´nus extra Ã  Sanidade MÃ¡xima" />
          </div>
        </div>
      </div>
      <div class="hp-mana-container">
        <input type="number" id="sanidade-current" name="sanidade-current" class="current-value" placeholder="0" min="0" aria-label="Sanidade atual" />
        <span class="separator">/</span>
        <input type="number" id="sanidade-max" name="sanidade-max" readonly class="max-value" aria-label="Sanidade mÃ¡xima" />
      </div>
      <div class="stat-progress-bar" role="progressbar" aria-label="Progresso de Sanidade" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="stat-progress-fill stat-progress-sanidade" id="sanidade-progress-fill"></div>
      </div>
      <div class="sanity-buttons-row">
        <button type="button" id="sanity-popup-btn" class="sanity-popup-btn" aria-label="Insanidades e traumas" title="Insanidades e traumas">ğŸ§ </button>
        <button type="button" id="sanity-test-btn" class="sanity-test-btn" title="Teste de Sanidade: (mod Sobrenatural + mod Mente) Ã· 2" aria-label="Rolar teste de sanidade">ğŸ²</button>
      </div>
    </div>
    <div class="header-item">
      <label for="caminho">Caminho</label>
      <select id="caminho" name="caminho" class="header-select" disabled>
        <option value="">--</option>
        <option value="Caminho do Enforcado">ğŸ”— Caminho do Enforcado</option>
        <option value="Caminho da EscuridÃ£o">ğŸŒ‘ Caminho da EscuridÃ£o</option>
        <option value="Caminho da Morte">ğŸ’€ Caminho da Morte</option>
        <option value="Caminho do Gigante do CrepÃºsculo">ğŸŒ† Caminho do Gigante do CrepÃºsculo</option>
        <option value="Caminho da Daemonia">ğŸ‘¹ Caminho da Daemonia</option>
        <option value="Caminho do Sacerdote Carmesim">â›ª Caminho do Sacerdote Carmesim</option>
        <option value="Caminho do Eremita">ğŸ§˜ Caminho do Eremita</option>
        <option value="Caminho do Exemplar">â­ Caminho do Exemplar</option>
        <option value="Caminho da Roda da Fortuna">ğŸ¡ Caminho da Roda da Fortuna</option>
        <option value="Caminho do Tolo">ğŸƒ Caminho do Tolo</option>
        <option value="Caminho da Anomalia">ğŸŒ€ Caminho da Anomalia</option>
        <option value="Caminho da Porta">ğŸšª Caminho da Porta</option>
        <option value="Caminho do VisionÃ¡rio">ğŸ‘ï¸ Caminho do VisionÃ¡rio</option>
        <option value="Caminho do Sol">â˜€ï¸ Caminho do Sol</option>
        <option value="Caminho do Tirano">ğŸ‘‘ Caminho do Tirano</option>
        <option value="Caminho da Torre PÃ¡lida">ğŸ—¼ Caminho da Torre PÃ¡lida</option>
      </select>
    </div>
    <div class="header-item">
      <label for="nivel-caminho">SequÃªncia</label>
      <input type="text" id="nivel-caminho" name="nivel-caminho" placeholder="0" readonly class="header-value" />
    </div>
    <div class="header-item">
      <label for="nivel">NÃ­vel</label>
      <select id="nivel" name="nivel" class="header-select">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
        <option value="19">19</option>
        <option value="20">20</option>
      </select>
    </div>
    <div class="header-item">
      <label for="prestigio">PrestÃ­gio em Sociedades Secretas</label>
      <select id="prestigio" name="prestigio" class="header-select">
        <option value="">--</option>
        <option value="muito-baixo">â—‡ Muito baixo</option>
        <option value="baixo">â—‡â—‡ Baixo</option>
        <option value="medio">â—‡â—‡â—‡ MÃ©dio</option>
        <option value="alto">â—‡â—‡â—‡â—‡ Alto</option>
        <option value="muito-alto">â—‡â—‡â—‡â—‡â—‡ Muito alto</option>
        <option value="supremo">â—† Supremo</option>
      </select>
    </div>
    <div class="header-item">
      <label for="resistencia">ResistÃªncia a dano fÃ­sico</label>
      <input type="number" id="resistencia" name="resistencia" readonly class="header-value" />
    </div>
    <div class="header-item">
      <label for="movimento">Movimento</label>
      <div class="movement-container">
        <input type="text" id="movimento" name="movimento" readonly class="header-value movement-base" />
        <input type="number" id="movimento-extra" name="movimento-extra" class="movement-extra" placeholder="+0" min="0" title="MovimentaÃ§Ã£o extra" />
      </div>
    </div>
    <div class="header-item nd-damage-heal-row">
      <div class="nd-projeteis-block">
        <div class="nd-projeteis-header">
          <label for="dt-projeteis">ND projÃ©teis</label>
          <div class="cobertura-btns" role="group" aria-label="Cobertura">
            <button type="button" class="cobertura-btn" data-cobertura="b" title="Baixa (+2)">B</button>
            <button type="button" class="cobertura-btn" data-cobertura="m" title="MÃ©dia (+4)">M</button>
            <button type="button" class="cobertura-btn" data-cobertura="a" title="Alta (+8)">A</button>
          </div>
        </div>
        <input type="number" id="dt-projeteis" name="dt-projeteis" readonly class="header-value" aria-label="ND projÃ©teis receber" />
      </div>
      <div class="damage-heal-block">
        <label class="damage-calc-label">Aplicar Dano</label>
        <div class="damage-calc-inline-grid">
          <input type="number" id="dano-vida" class="damage-input-inline" placeholder="V" min="0" aria-label="Dano Vida" title="Dano em Vida" />
          <input type="number" id="dano-mana" class="damage-input-inline" placeholder="M" min="0" aria-label="Dano Mana" title="Dano em Mana" />
          <input type="number" id="dano-sanidade" class="damage-input-inline" placeholder="S" min="0" aria-label="Dano San" title="Dano em Sanidade" />
          <button type="button" id="aplicar-dano-btn" class="aplicar-dano-btn-inline" aria-label="Aplicar dano">Aplicar</button>
        </div>
      </div>
      <div class="damage-heal-block">
        <label class="damage-calc-label">Aplicar Cura</label>
        <div class="damage-calc-inline-grid">
          <input type="number" id="cura-vida" class="heal-input-inline" placeholder="V" min="0" aria-label="Cura Vida" title="Cura em Vida" />
          <input type="number" id="cura-mana" class="heal-input-inline" placeholder="M" min="0" aria-label="Cura Mana" title="Cura em Mana" />
          <input type="number" id="cura-sanidade" class="heal-input-inline" placeholder="S" min="0" aria-label="Cura San" title="Cura em Sanidade" />
          <button type="button" id="aplicar-cura-btn" class="aplicar-cura-btn-inline" aria-label="Aplicar cura">Aplicar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- BotÃµes de Descanso e CondiÃ§Ãµes -->
  <div class="rest-buttons-section">
    <h3 class="rest-buttons-title">Descanso</h3>
    <div class="rest-conditions-row">
      <div class="rest-buttons-grid">
      <button type="button" class="rest-btn rest-ruim" data-rest="ruim" title="Vida 1/4, Mana 1/4, Sanidade 1/6" aria-label="Descanso ruim - recupera 1/4 Vida, 1/4 Mana, 1/6 Sanidade">Ruim</button>
      <button type="button" class="rest-btn rest-mediano" data-rest="mediano" title="Vida 1/3, Mana 1/3, Sanidade 1/4">Mediano</button>
      <button type="button" class="rest-btn rest-bom" data-rest="bom" title="Vida 1/2, Mana 1/2, Sanidade 1/3">Bom</button>
      <button type="button" class="rest-btn rest-magico" data-rest="magico" title="RecuperaÃ§Ã£o total">MÃ¡gico</button>
      </div>
      <button type="button" id="conditions-btn" class="conditions-btn" title="Ver condiÃ§Ãµes" aria-label="Abrir condiÃ§Ãµes">âš¡ CondiÃ§Ãµes</button>
    </div>
  </div>

  <div id="conditions-popup" class="conditions-popup" style="display: none;">
    <div class="conditions-overlay"></div>
    <div class="conditions-content">
      <div class="conditions-header">
        <h3>CondiÃ§Ãµes</h3>
        <button type="button" id="conditions-close" aria-label="Fechar">âœ•</button>
      </div>
      <div class="conditions-body">
        <p class="conditions-desc">Marque as condiÃ§Ãµes ativas no personagem. Machucado e Morrendo sÃ£o aplicados automaticamente.</p>
        <div id="conditions-list" class="conditions-list">
          <!-- Preenchido via JS -->
        </div>
      </div>
    </div>
  </div>

  
  <div class="status-container-inline" id="status-container-inline">
    <!-- Status serÃ¡ inserido aqui -->
  </div>
  
  <div class="death-saves-container" id="death-saves-container" style="display: none;">
    <h3 class="death-saves-title">Testes de Salvamento</h3>
    <div class="death-saves-grid">
      <div class="death-saves-group">
        <label class="death-saves-label">Sucessos</label>
        <div class="death-saves-checkboxes">
          <label class="death-save-checkbox-label">
            <input type="checkbox" class="death-save-checkbox" data-type="success" />
          </label>
          <label class="death-save-checkbox-label">
            <input type="checkbox" class="death-save-checkbox" data-type="success" />
          </label>
          <label class="death-save-checkbox-label">
            <input type="checkbox" class="death-save-checkbox" data-type="success" />
          </label>
        </div>
      </div>
      <div class="death-saves-group">
        <label class="death-saves-label">Fracassos</label>
        <div class="death-saves-checkboxes">
          <label class="death-save-checkbox-label">
            <input type="checkbox" class="death-save-checkbox" data-type="failure" />
          </label>
          <label class="death-save-checkbox-label">
            <input type="checkbox" class="death-save-checkbox" data-type="failure" />
          </label>
          <label class="death-save-checkbox-label">
            <input type="checkbox" class="death-save-checkbox" data-type="failure" />
          </label>
        </div>
      </div>
    </div>
  </div>
</section>

<script type="module">
  // Integrar Status inline no Header
  function renderInlineStatus() {
    const container = document.getElementById('status-container-inline');
    if (!container) return;
    
    const vidaCurrentInput = document.getElementById('vida-current');
    const vidaMaxInput = document.getElementById('vida-max');
    const sanidadeCurrentInput = document.getElementById('sanidade-current');
    const sanidadeMaxInput = document.getElementById('sanidade-max');
    
    if (!vidaCurrentInput || !vidaMaxInput || !sanidadeCurrentInput || !sanidadeMaxInput) {
      return;
    }
    
    const vc = parseInt(vidaCurrentInput.value, 10);
    const vm = parseInt(vidaMaxInput.value, 10);
    const sc = parseInt(sanidadeCurrentInput.value, 10);
    const sm = parseInt(sanidadeMaxInput.value, 10);
    
    const vidaCurrent = Number.isNaN(vc) ? 0 : vc;
    const vidaMax = Number.isNaN(vm) ? 0 : vm;
    const sanidadeCurrent = Number.isNaN(sc) ? 0 : sc;
    const sanidadeMax = Number.isNaN(sm) ? 0 : sm;
    
    const isMachucado = vidaMax > 0 && vidaCurrent < vidaMax / 2 && vidaCurrent > 0;
    const isMorrendo = vidaCurrent === 0;
    const isInsano = sanidadeMax > 0 && sanidadeCurrent < sanidadeMax / 2;
    const activeConditions = Array.from(document.querySelectorAll('#conditions-list input.condition-check:checked')).map(cb => cb.value);
    
    container.innerHTML = '';
    const hasAuto = isMachucado || isMorrendo || isInsano;
    const hasManual = activeConditions.length > 0;
    
    if (hasAuto || hasManual) {
      container.style.display = 'flex';
      container.innerHTML = '<span class="status-label-inline">Status:</span>';
      
      const condMap = {};
      CONDITIONS_DATA.forEach(c => { condMap[c.id] = c; });
      
      if (isMachucado) {
        const c = condMap['machucado'];
        const span = document.createElement('span');
        span.className = 'status-badge status-machucado';
        span.innerHTML = `${c?.emoji || 'âš ï¸'} <strong>Machucado</strong> â€” ${c?.desc || 'Movimento reduzido pela metade.'}`;
        container.appendChild(span);
      }
      
      if (isMorrendo) {
        const c = condMap['morrendo'];
        const span = document.createElement('span');
        span.className = 'status-badge status-morrendo';
        span.innerHTML = `${c?.emoji || 'â—‹'} <strong>Morrendo</strong> â€” ${c?.desc || 'Movimento zerado. FaÃ§a testes de salvamento.'}`;
        container.appendChild(span);
      }

      if (isInsano) {
        const span = document.createElement('span');
        span.className = 'status-badge status-insano';
        span.innerHTML = 'ğŸ§  <strong>Insano</strong> â€” Sanidade abaixo de 50%.';
        container.appendChild(span);
      }
      
      activeConditions.forEach(id => {
        const c = condMap[id];
        const name = c?.name || id;
        const desc = c?.desc || '';
        const emoji = c?.emoji || 'âš¡';
        const span = document.createElement('span');
        span.className = 'status-badge status-condition';
        span.innerHTML = `${emoji} <strong>${name}</strong> â€” ${desc}`;
        container.appendChild(span);
      });
    } else {
      container.style.display = 'none';
    }
    
    // Mostrar/ocultar testes de salvamento quando morrendo
    const deathSavesContainer = document.getElementById('death-saves-container');
    if (deathSavesContainer) {
      if (isMorrendo) {
        deathSavesContainer.style.display = 'block';
      } else {
        deathSavesContainer.style.display = 'none';
        document.querySelectorAll('.death-save-checkbox').forEach(cb => {
          cb.checked = false;
        });
      }
    }
  }
  
  // Atualizar status quando valores mudarem
  function updateInlineStatus() {
    renderInlineStatus();
  }
  
  // Escutar mudanÃ§as
  // CondiÃ§Ãµes popup - define dados e popula lista ao carregar
  const CONDITIONS_DATA = [
    { id: 'machucado', name: 'Machucado', desc: 'Movimento reduzido pela metade.', emoji: 'âš ï¸', auto: true },
    { id: 'morrendo', name: 'Morrendo', desc: 'Movimento zerado. FaÃ§a testes de salvamento.', emoji: 'â—‹', auto: true },
    { id: 'atordoado', name: 'Atordoado', desc: 'Incapacitado, nÃ£o pode se mover ou agir.', emoji: 'ğŸ’«', auto: false },
    { id: 'cego', name: 'Cego', desc: 'Desvantagem em testes que dependem da visÃ£o.', emoji: 'ğŸ‘ï¸â€ğŸ—¨ï¸', auto: false },
    { id: 'surdo', name: 'Surdo', desc: 'Desvantagem em testes que dependem da audiÃ§Ã£o.', emoji: 'ğŸ‘‚', auto: false },
    { id: 'enfeiticado', name: 'EnfeitiÃ§ado', desc: 'NÃ£o pode atacar o enfeitiÃ§ador ou usar aÃ§Ãµes nocivas contra ele.', emoji: 'âœ¨', auto: false },
    { id: 'envenenado', name: 'Envenenado', desc: 'Dano periÃ³dico. Desvantagem em testes atÃ© ser curado.', emoji: 'â˜ ï¸', auto: false },
    { id: 'queimado', name: 'Queimado', desc: 'Dano contÃ­nuo. Desvantagem atÃ© extinguir.', emoji: 'ğŸ”¥', auto: false },
    { id: 'assustado', name: 'Assustado', desc: 'Desvantagem enquanto a fonte do medo estiver visÃ­vel.', emoji: 'ğŸ˜±', auto: false },
    { id: 'paralisado', name: 'Paralisado', desc: 'Incapacitado. NÃ£o pode se mover ou falar.', emoji: 'ğŸ§Š', auto: false },
    { id: 'inconsciente', name: 'Inconsciente', desc: 'Desmaiado. Incapacitado e vulnerÃ¡vel.', emoji: 'ğŸ’¤', auto: false },
    { id: 'agarrado', name: 'Agarrado', desc: 'Movimento zerado. Depende da aÃ§Ã£o para se libertar.', emoji: 'ğŸ¤²', auto: false },
    { id: 'restrito', name: 'Restrito', desc: 'Movimento zerado. Desvantagem em ataques e testes.', emoji: 'â›“ï¸', auto: false },
    { id: 'incapacitado', name: 'Incapacitado', desc: 'NÃ£o pode realizar aÃ§Ãµes.', emoji: 'ğŸš«', auto: false },
    { id: 'escondido', name: 'Escondido', desc: 'DifÃ­cil de ser detectado. Vantagem em ataques surpresa.', emoji: 'ğŸ™ˆ', auto: false },
    { id: 'invisivel', name: 'InvisÃ­vel', desc: 'NÃ£o pode ser visto. Vantagem em ataques.', emoji: 'ğŸ‘»', auto: false },
    { id: 'sobrecarregado', name: 'Sobrecarregado', desc: 'Peso > mÃ¡ximo. Movimento reduzido pela metade.', emoji: 'ğŸ“¦', auto: true },
  ];
  
  document.addEventListener('DOMContentLoaded', () => {
    const popup = document.getElementById('conditions-popup');
    const list = document.getElementById('conditions-list');
    const openBtn = document.getElementById('conditions-btn');
    const closeBtn = document.getElementById('conditions-close');
    const overlay = popup?.querySelector('.conditions-overlay');
    
    if (list) {
      list.innerHTML = CONDITIONS_DATA.filter(c => !c.auto).map(c => `
        <div class="condition-check-item" data-condition-id="${c.id}" data-condition-emoji="${c.emoji || 'âš¡'}" data-condition-desc="${(c.desc || '').replace(/"/g, '&quot;')}">
          <input type="checkbox" class="condition-check" id="cond-${c.id}" value="${c.id}" aria-label="${c.name}" />
          <label for="cond-${c.id}">
            <strong>${c.name}</strong>
            <span class="cond-desc">${c.desc}</span>
          </label>
        </div>
      `).join('');
    }
    
    function openConditions() {
      if (popup) { popup.style.display = 'flex'; popup.dataset.open = 'true'; document.body.style.overflow = 'hidden'; }
    }
    function closeConditions() {
      if (popup) { popup.style.display = 'none'; popup.dataset.open = ''; document.body.style.overflow = ''; }
    }
    
    openBtn?.addEventListener('click', openConditions);
    closeBtn?.addEventListener('click', closeConditions);
    overlay?.addEventListener('click', closeConditions);
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && popup?.dataset.open === 'true') closeConditions();
    });
    
    window.getConditionsData = () => Array.from(document.querySelectorAll('#conditions-list input.condition-check:checked')).map(cb => cb.value);
    window.loadConditionsData = (ids) => {
      document.querySelectorAll('#conditions-list input.condition-check').forEach(cb => { cb.checked = ids?.includes(cb.value) || false; });
    };
  });

  document.addEventListener('change', (e) => {
    if (e.target?.classList?.contains('condition-check')) updateInlineStatus();
  });

  ['vida-current', 'vida-max', 'mana-current', 'mana-max', 'sanidade-current', 'sanidade-max'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', () => { updateInlineStatus(); updateProgressBars(); });
      el.addEventListener('change', () => { updateInlineStatus(); updateProgressBars(); });
    }
  });

  // BotÃ£o Sanidade - abre popup (SanitySystem registra openSanityPopup)
  document.getElementById('sanity-popup-btn')?.addEventListener('click', () => {
    if (typeof window.openSanityPopup === 'function') {
      window.openSanityPopup();
    }
  });

  // BotÃ£o Teste de Sanidade - (mod Sobrenatural + mod Mente) / 2
  document.getElementById('sanity-test-btn')?.addEventListener('click', () => {
    const sobrenatural = parseInt(document.getElementById('sobrenatural')?.value || '0', 10) || 0;
    const mente = parseInt(document.getElementById('mente')?.value || '0', 10) || 0;
    const modSobrenatural = Math.floor((sobrenatural - 10) / 2);
    const modMente = Math.floor((mente - 10) / 2);
    const bonus = Math.floor((modSobrenatural + modMente) / 2);
    const d20 = Math.floor(Math.random() * 20) + 1;
    const total = d20 + bonus;
    const label = `Teste de Sanidade (1d20${bonus >= 0 ? '+' : ''}${bonus})`;
    if (typeof window.showDiceRollPopup === 'function') {
      window.showDiceRollPopup({ result: d20, modifier: bonus, total, critical: d20 === 20, fumble: d20 === 1 }, label, 'd20');
    } else {
      alert(`${label}: ${d20} + ${bonus} = ${total}`);
    }
  });
  
  // Atualizar inicial
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      requestAnimationFrame(() => { updateInlineStatus(); updateProgressBars(); });
    }, { once: true });
  } else {
    requestAnimationFrame(() => { updateInlineStatus(); updateProgressBars(); });
  }
  
  function updateProgressBars() {
    ['vida', 'mana', 'sanidade'].forEach(stat => {
      const cur = document.getElementById(`${stat}-current`);
      const max = document.getElementById(`${stat}-max`);
      const fill = document.getElementById(`${stat}-progress-fill`);
      const bar = fill?.closest('.stat-progress-bar');
      if (!cur || !max || !fill || !bar) return;
      const cv = parseInt(cur.value, 10) || 0;
      const mv = parseInt(max.value, 10) || 0;
      const pct = mv > 0 ? Math.min(100, Math.max(0, (cv / mv) * 100)) : 0;
      fill.style.width = `${pct}%`;
      bar.setAttribute('aria-valuenow', String(Math.round(pct)));
    });
  }

  // Expor funÃ§Ã£o globalmente
  window.updateInlineStatus = updateInlineStatus;
  window.updateProgressBars = updateProgressBars;
</script>

<script type="module">
  // FunÃ§Ã£o para calcular modificador de atributo (JS puro)
  function getAttributeModifier(attributeValue) {
    return Math.floor((attributeValue - 10) / 2);
  }

  // FunÃ§Ã£o para obter valor de atributo (igual ao usado na rolagem de dados)
  function getAttributeValue(attributeId) {
    const input = document.getElementById(attributeId);
    if (!input) {
      console.warn(`Atributo ${attributeId} nÃ£o encontrado no DOM`);
      return 0;
    }
    const v = parseInt(input.value, 10);
    return Number.isNaN(v) ? 0 : v;
  }

  // Flag para evitar loops infinitos e debounce
  let isUpdating = false;
  let updateTimeout = null;

  // FunÃ§Ã£o para atualizar todos os valores derivados
  function updateHeaderValues(immediate = false) {
    // Prevenir loops infinitos
    if (isUpdating) return;
    
    // Se immediate, atualizar sem debounce (para campos temporÃ¡rios)
    if (immediate) {
      isUpdating = true;
      try {
        _updateHeaderValues();
      } finally {
        isUpdating = false;
      }
      return;
    }
    
    // Debounce: cancelar atualizaÃ§Ã£o pendente e agendar nova
    if (updateTimeout !== null) {
      clearTimeout(updateTimeout);
    }
    
    updateTimeout = window.setTimeout(() => {
      isUpdating = true;
      try {
        _updateHeaderValues();
      } finally {
        isUpdating = false;
      }
      updateTimeout = null;
    }, 50);
  }

  // FunÃ§Ã£o interna que faz a atualizaÃ§Ã£o real
  function _updateHeaderValues() {

      // Obter valores dos atributos diretamente do DOM (igual Ã  rolagem de dados)
      // Pegar os inputs diretamente e ler os valores, como a rolagem faz
      const forInput = document.getElementById('brutalidade');
      const dexInput = document.getElementById('destreza');
      const conInput = document.getElementById('compleicao');
      const menInput = document.getElementById('mente');
      const podInput = document.getElementById('sobrenatural');
      
      // Ler valores diretamente dos inputs, igual Ã  rolagem
      const forV = forInput ? parseInt(forInput.value, 10) : 0;
      const dexV = dexInput ? parseInt(dexInput.value, 10) : 0;
      const conV = conInput ? parseInt(conInput.value, 10) : 0;
      const menV = menInput ? parseInt(menInput.value, 10) : 0;
      const podV = podInput ? parseInt(podInput.value, 10) : 0;
      
      const forValue = Number.isNaN(forV) ? 0 : forV;
      const dexValue = Number.isNaN(dexV) ? 0 : dexV;
      const conValue = Number.isNaN(conV) ? 0 : conV;
      const menValue = Number.isNaN(menV) ? 0 : menV;
      const podValue = Number.isNaN(podV) ? 0 : podV;
      
      // Calcular modificadores
      const modFor = getAttributeModifier(forValue);
      const modDex = getAttributeModifier(dexValue);
      const modCon = getAttributeModifier(conValue);
      const modConj = getAttributeModifier(podValue); // MODconj = modificador de conjuraÃ§Ã£o (sobrenatural)
      const modEsq = getAttributeModifier(dexValue); // MODesq = modificador de esquiva (destreza)

      // Vida: Brutalidade + CompleiÃ§Ã£o + bÃ´nus nÃ­vel + bÃ´nus extra
      const vidaMaxInput = document.getElementById('vida-max');
      const vidaTempInput = document.getElementById('vida-temp');
      const vidaExtraInput = document.getElementById('vida-extra');
      if (vidaMaxInput) {
        const vidaTempV = vidaTempInput ? parseInt(vidaTempInput.value, 10) : 0;
        const vidaExtraV = vidaExtraInput ? parseInt(vidaExtraInput.value, 10) : 0;
        const vidaTempValue = Number.isNaN(vidaTempV) ? 0 : vidaTempV;
        const vidaExtraValue = Number.isNaN(vidaExtraV) ? 0 : vidaExtraV;
        const maxVida = forValue + conValue + vidaTempValue + vidaExtraValue;
        vidaMaxInput.value = String(maxVida);
        
        // Garantir que vida atual nÃ£o exceda mÃ¡ximo
        const vidaCurrentInput = document.getElementById('vida-current');
        if (vidaCurrentInput) {
          const vc = parseInt(vidaCurrentInput.value, 10);
          const currentValue = Number.isNaN(vc) ? 0 : vc;
          if (currentValue > maxVida && maxVida > 0) {
            vidaCurrentInput.value = String(maxVida);
          }
          vidaCurrentInput.max = String(maxVida);
        }
      }

      // Mana: Sobrenatural * 2 + bÃ´nus nÃ­vel + bÃ´nus extra
      const manaMaxInput = document.getElementById('mana-max');
      const manaTempInput = document.getElementById('mana-temp');
      const manaExtraInput = document.getElementById('mana-extra');
      if (manaMaxInput) {
        const manaTempV = manaTempInput ? parseInt(manaTempInput.value, 10) : 0;
        const manaExtraV = manaExtraInput ? parseInt(manaExtraInput.value, 10) : 0;
        const manaTempValue = Number.isNaN(manaTempV) ? 0 : manaTempV;
        const manaExtraValue = Number.isNaN(manaExtraV) ? 0 : manaExtraV;
        const maxMana = podValue * 2 + manaTempValue + manaExtraValue;
        manaMaxInput.value = String(maxMana);
        
        // Garantir que mana atual nÃ£o exceda mÃ¡ximo
        const manaCurrentInput = document.getElementById('mana-current');
        if (manaCurrentInput) {
          const vc = parseInt(manaCurrentInput.value, 10);
          const currentValue = Number.isNaN(vc) ? 0 : vc;
          if (currentValue > maxMana && maxMana > 0) {
            manaCurrentInput.value = String(maxMana);
          }
          manaCurrentInput.max = String(maxMana);
        }
      }

      // Sanidade: Mente * 2 + bÃ´nus nÃ­vel + bÃ´nus extra
      const sanidadeMaxInput = document.getElementById('sanidade-max');
      const sanidadeTempInput = document.getElementById('sanidade-temp');
      const sanidadeExtraInput = document.getElementById('sanidade-extra');
      if (sanidadeMaxInput) {
        const sanidadeTempV = sanidadeTempInput ? parseInt(sanidadeTempInput.value, 10) : 0;
        const sanidadeExtraV = sanidadeExtraInput ? parseInt(sanidadeExtraInput.value, 10) : 0;
        const sanidadeTempValue = Number.isNaN(sanidadeTempV) ? 0 : sanidadeTempV;
        const sanidadeExtraValue = Number.isNaN(sanidadeExtraV) ? 0 : sanidadeExtraV;
        const maxSanidade = menValue * 2 + sanidadeTempValue + sanidadeExtraValue;
        sanidadeMaxInput.value = String(maxSanidade);
        
        // Garantir que sanidade atual nÃ£o exceda mÃ¡ximo
        const sanidadeCurrentInput = document.getElementById('sanidade-current');
        if (sanidadeCurrentInput) {
          const cs = parseInt(sanidadeCurrentInput.value, 10);
          const currentValue = Number.isNaN(cs) ? 0 : cs;
          if (currentValue > maxSanidade && maxSanidade > 0) {
            sanidadeCurrentInput.value = String(maxSanidade);
          }
          sanidadeCurrentInput.max = String(maxSanidade);
        }
      }

      // ResistÃªncias a dano: MODcon + MODfor/2
      const resistenciaInput = document.getElementById('resistencia');
      if (resistenciaInput) {
        const resistencia = modCon + Math.floor(modFor / 2);
        resistenciaInput.value = String(resistencia);
      }

      // Movimento: MODdex * 2"m" (ou metade se sobrecarregado ou machucado) + movimento extra
      const movimentoInput = document.getElementById('movimento');
      const movimentoExtraInput = document.getElementById('movimento-extra');
      if (movimentoInput) {
        // Verificar se estÃ¡ sobrecarregado (peso atual > peso mÃ¡ximo)
        let currentWeight = 0;
        let maxWeight = 0;
        
        // Tentar obter peso atual e mÃ¡ximo dos itens
        const weightCurrentEl = document.getElementById('weight-current');
        const weightMaxEl = document.getElementById('weight-max');
        
        if (weightCurrentEl && weightMaxEl) {
          const wc = parseInt(weightCurrentEl.textContent, 10);
          const wm = parseInt(weightMaxEl.textContent, 10);
          currentWeight = Number.isNaN(wc) ? 0 : wc;
          maxWeight = Number.isNaN(wm) ? 0 : wm;
        }
        
        // Verificar se estÃ¡ machucado (vida atual < metade da vida mÃ¡xima)
        const vidaCurrentInput = document.getElementById('vida-current');
        const vidaMaxInput = document.getElementById('vida-max');
        let isMachucado = false;
        if (vidaCurrentInput && vidaMaxInput) {
          const vc = parseInt(vidaCurrentInput.value, 10);
          const vm = parseInt(vidaMaxInput.value, 10);
          const vidaCurrent = Number.isNaN(vc) ? 0 : vc;
          const vidaMax = Number.isNaN(vm) ? 0 : vm;
          if (vidaMax > 0 && vidaCurrent < vidaMax / 2 && vidaCurrent > 0) {
            isMachucado = true;
          }
        }
        
        // Movimento: Destreza / 2
        let movimento = Math.floor(dexValue / 2);
        
        // Se sobrecarregado (peso atual > peso mÃ¡ximo), movimento Ã© metade
        if (currentWeight > maxWeight && maxWeight > 0) {
          movimento = Math.floor(movimento / 2);
        }
        
        // Verificar se estÃ¡ morrendo (vida atual = 0)
        let isMorrendo = false;
        if (vidaCurrentInput && vidaMaxInput) {
          const vc = parseInt(vidaCurrentInput.value, 10);
          const vidaCurrent = Number.isNaN(vc) ? 0 : vc;
          if (vidaCurrent === 0) {
            isMorrendo = true;
          }
        }
        
        // Se morrendo, movimento Ã© zero
        if (isMorrendo) {
          movimento = 0;
        } else {
          // Se machucado, movimento Ã© metade
          if (isMachucado) {
            movimento = Math.floor(movimento / 2);
          }
          
          // Adicionar movimento extra
          if (movimentoExtraInput) {
            const me = parseInt(movimentoExtraInput.value, 10);
            const movimentoExtra = Number.isNaN(me) ? 0 : me;
            movimento += movimentoExtra;
          }
        }
        
        movimentoInput.value = `${movimento}m`;
      }

      // ND projÃ©teis: 8 + MODesq + cobertura (B+2, M+4, A+8)
      const dtProjeteisInput = document.getElementById('dt-projeteis');
      if (dtProjeteisInput) {
        const coberturaActive = document.querySelector('.cobertura-btn.active');
        const coberturaBonus = coberturaActive ? ({ b: 2, m: 4, a: 8 }[coberturaActive.dataset.cobertura] || 0) : 0;
        const ndProjeteis = 8 + modEsq + coberturaBonus;
        dtProjeteisInput.value = String(ndProjeteis);
      }

      // SequÃªncia baseada no nÃ­vel
      const nivelInput = document.getElementById('nivel');
      const sequenciaInput = document.getElementById('nivel-caminho');
      if (nivelInput && sequenciaInput) {
        const n = parseInt(nivelInput.value, 10);
        const nivel = Number.isNaN(n) ? 0 : n;
        let sequencia = 0;
        
        if (nivel >= 1 && nivel <= 2) sequencia = 9;
        else if (nivel >= 3 && nivel <= 4) sequencia = 8;
        else if (nivel >= 5 && nivel <= 6) sequencia = 7;
        else if (nivel >= 7 && nivel <= 8) sequencia = 6;
        else if (nivel >= 9 && nivel <= 10) sequencia = 5;
        else if (nivel >= 11 && nivel <= 12) sequencia = 4;
        else if (nivel >= 13 && nivel <= 14) sequencia = 3;
        else if (nivel >= 15 && nivel <= 16) sequencia = 2;
        else if (nivel >= 17 && nivel <= 20) sequencia = 1;
        
        const sequenciaText = sequencia > 0 ? `${sequencia}Âª sequÃªncia` : '0';
        sequenciaInput.value = sequenciaText;
        
        // Habilitar/desabilitar Caminho baseado no nÃ­vel
        const caminhoSelect = document.getElementById('caminho');
        if (caminhoSelect) {
          if (nivel >= 1) {
            caminhoSelect.disabled = false;
          } else {
            caminhoSelect.disabled = true;
            caminhoSelect.value = '';
          }
        }
        
        // Habilitar/desabilitar PrestÃ­gio baseado no nÃ­vel
        const prestigioSelect = document.getElementById('prestigio');
        if (prestigioSelect) {
          if (nivel >= 1) {
            prestigioSelect.disabled = false;
            if (!prestigioSelect.value || prestigioSelect.value === '') {
              prestigioSelect.value = 'muito-baixo';
            }
          } else {
            prestigioSelect.disabled = true;
            prestigioSelect.value = '';
          }
        }
      }

      if (typeof window.updateProgressBars === 'function') window.updateProgressBars();
  }

  // FunÃ§Ã£o para reduzir sanidade quando Caminho for preenchido
  function handleCaminhoChange() {
    const caminhoSelect = document.getElementById('caminho');
    const sanidadeMaxInput = document.getElementById('sanidade-max');
    const sanidadeCurrentInput = document.getElementById('sanidade-current');
    
    if (!caminhoSelect || !sanidadeMaxInput) return;
    
    // Verificar se Caminho foi preenchido pela primeira vez
    const caminhoValue = caminhoSelect.value.trim();
    const wasEmpty = caminhoSelect.dataset.wasEmpty === 'true';
    
    if (caminhoValue && wasEmpty && caminhoSelect.dataset.sanidadeReduced !== 'true') {
      // Reduzir 10% da sanidade mÃ¡xima, arredondando para cima
      const ms = parseInt(sanidadeMaxInput.value, 10);
      const maxSanidade = Number.isNaN(ms) ? 0 : ms;
      if (maxSanidade > 0) {
        const reducao = Math.ceil(maxSanidade * 0.1);
        const novaMaxSanidade = maxSanidade - reducao;
        sanidadeMaxInput.value = String(novaMaxSanidade);
        
        // Ajustar sanidade atual se necessÃ¡rio
        if (sanidadeCurrentInput) {
          const cs = parseInt(sanidadeCurrentInput.value, 10);
          const currentSanidade = Number.isNaN(cs) ? 0 : cs;
          if (currentSanidade > novaMaxSanidade) {
            sanidadeCurrentInput.value = String(novaMaxSanidade);
          }
          sanidadeCurrentInput.max = String(novaMaxSanidade);
        }
        
        // Marcar que jÃ¡ foi reduzido
        caminhoSelect.dataset.sanidadeReduced = 'true';
        
        // Atualizar status
        if (window.updateStatus) {
          window.updateStatus();
        }
      }
    }
    
    // Atualizar flag
    caminhoSelect.dataset.wasEmpty = caminhoValue ? 'false' : 'true';
  }

  // Escutar mudanÃ§as nos atributos usando event delegation Ãºnica e global
  // Usar flag global no window para garantir que seja adicionado apenas uma vez
  if (!window.headerListenerInitialized) {
    window.headerListenerInitialized = true;
    const attributeIds = ['brutalidade', 'destreza', 'compleicao', 'mente', 'sobrenatural'];
    
    // Event delegation Ãºnica - executar apenas uma vez
    // Escutar no document com capture para pegar eventos de qualquer elemento
    document.addEventListener('change', (e) => {
      const target = e.target;
      if (target && target.id && attributeIds.includes(target.id)) {
        updateHeaderValues();
      }
    }, { passive: true, capture: true });

    document.addEventListener('click', (e) => {
      const btn = e.target?.closest('.cobertura-btn');
      if (!btn) return;
      if (btn.classList.contains('active')) {
        btn.classList.remove('active');
      } else {
        document.querySelectorAll('.cobertura-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      }
      updateHeaderValues(true);
    });

    // Escutar eventos de input tambÃ©m para atualizaÃ§Ã£o em tempo real
    document.addEventListener('input', (e) => {
      const target = e.target;
      if (target && target.id && attributeIds.includes(target.id)) {
        updateHeaderValues();
      }
    }, { passive: true, capture: true });

    // FunÃ§Ã£o para tentar inicializar valores - tentar mÃºltiplas vezes se necessÃ¡rio
    function initializeValues(retries = 0) {
      // Verificar se todos os atributos existem no DOM
      const allAttributesExist = attributeIds.every(id => {
        const element = document.getElementById(id);
        return element !== null;
      });

      if (allAttributesExist) {
        // Todos os atributos existem, atualizar valores
        updateHeaderValues();
      } else if (retries < 10) {
        // Ainda nÃ£o existem, tentar novamente apÃ³s 50ms
        setTimeout(() => {
          initializeValues(retries + 1);
        }, 50);
      } else {
        // ApÃ³s 10 tentativas (500ms), atualizar mesmo assim
        updateHeaderValues();
      }
    }

    // Atualizar valores iniciais apÃ³s o DOM estar pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initializeValues();
      }, { once: true });
    } else {
      initializeValues();
    }

    // Escutar mudanÃ§as via eventos globais (caso os atributos sejam atualizados de fora)
    document.addEventListener('characterDataChanged', () => {
      updateHeaderValues();
    }, { passive: true });

    // Escutar mudanÃ§as de peso para atualizar movimento
    document.addEventListener('weightChanged', () => {
      updateHeaderValues();
    }, { passive: true });

    // Usar event delegation para otimizar performance
    if (!window.headerEventDelegationInitialized) {
      window.headerEventDelegationInitialized = true;
      
      document.addEventListener('input', (e) => {
        const target = e.target;
        if (!target || !target.id) return;
        
        const id = target.id;
        if (id === 'vida-current' || id === 'sanidade-current') {
          updateHeaderValues();
        } else if (id === 'movimento-extra' || id === 'vida-temp' || id === 'mana-temp' || id === 'sanidade-temp' || id === 'vida-extra' || id === 'mana-extra' || id === 'sanidade-extra') {
          updateHeaderValues(true);
        } else if (id === 'nivel' || id === 'caminho') {
          updateHeaderValues();
        }
      }, { passive: true, capture: true });
      
      document.addEventListener('change', (e) => {
        const target = e.target;
        if (!target || !target.id) return;
        
        const id = target.id;
        if (id === 'vida-current' || id === 'sanidade-current') {
          updateHeaderValues();
        } else if (id === 'movimento-extra' || id === 'vida-temp' || id === 'mana-temp' || id === 'sanidade-temp' || id === 'vida-extra' || id === 'mana-extra' || id === 'sanidade-extra') {
          updateHeaderValues(true);
        } else if (id === 'nivel' || id === 'caminho') {
          updateHeaderValues();
        }
      }, { passive: true, capture: true });
    }

    // BotÃµes de Descanso
    const REST_VALUES = {
      ruim: { vida: 1/4, mana: 1/4, sanidade: 1/6 },
      mediano: { vida: 1/3, mana: 1/3, sanidade: 1/4 },
      bom: { vida: 1/2, mana: 1/2, sanidade: 1/3 },
      magico: { vida: 1, mana: 1, sanidade: 1 }
    };
    document.addEventListener('click', (e) => {
      const btn = e.target?.closest('.rest-btn');
      if (!btn) return;
      const tipo = btn.dataset.rest;
      const ratios = REST_VALUES[tipo];
      if (!ratios) return;
      const vidaMax = parseInt(document.getElementById('vida-max')?.value || '0', 10);
      const manaMax = parseInt(document.getElementById('mana-max')?.value || '0', 10);
      const sanidadeMax = parseInt(document.getElementById('sanidade-max')?.value || '0', 10);
      const vidaCur = document.getElementById('vida-current');
      const manaCur = document.getElementById('mana-current');
      const sanidadeCur = document.getElementById('sanidade-current');
      if (vidaCur) {
        const v = parseInt(vidaCur.value, 10) || 0;
        vidaCur.value = String(Math.min(vidaMax, Math.floor(v + vidaMax * ratios.vida)));
      }
      if (manaCur) {
        const m = parseInt(manaCur.value, 10) || 0;
        manaCur.value = String(Math.min(manaMax, Math.floor(m + manaMax * ratios.mana)));
      }
      if (sanidadeCur) {
        const s = parseInt(sanidadeCur.value, 10) || 0;
        sanidadeCur.value = String(Math.min(sanidadeMax, Math.floor(s + sanidadeMax * ratios.sanidade)));
      }
      if (typeof window.updateInlineStatus === 'function') window.updateInlineStatus();
      if (typeof updateHeaderValues === 'function') updateHeaderValues(true);
      if (typeof window.showToast === 'function') window.showToast(`Descanso ${tipo.charAt(0).toUpperCase() + tipo.slice(1)} aplicado`, 'success');
    });

    // Calculadora de Dano
    document.getElementById('aplicar-dano-btn')?.addEventListener('click', () => {
      const danoVida = parseInt(document.getElementById('dano-vida')?.value || '0', 10) || 0;
      const danoMana = parseInt(document.getElementById('dano-mana')?.value || '0', 10) || 0;
      const danoSanidade = parseInt(document.getElementById('dano-sanidade')?.value || '0', 10) || 0;
      const vidaCur = document.getElementById('vida-current');
      const manaCur = document.getElementById('mana-current');
      const sanidadeCur = document.getElementById('sanidade-current');
      if (vidaCur && danoVida > 0) {
        const v = parseInt(vidaCur.value, 10) || 0;
        vidaCur.value = String(Math.max(0, v - danoVida));
      }
      if (manaCur && danoMana > 0) {
        const m = parseInt(manaCur.value, 10) || 0;
        manaCur.value = String(Math.max(0, m - danoMana));
      }
      if (sanidadeCur && danoSanidade > 0) {
        const s = parseInt(sanidadeCur.value, 10) || 0;
        sanidadeCur.value = String(Math.max(0, s - danoSanidade));
      }
      const danoVidaEl = document.getElementById('dano-vida');
      const danoManaEl = document.getElementById('dano-mana');
      const danoSanidadeEl = document.getElementById('dano-sanidade');
      if (danoVidaEl) danoVidaEl.value = '';
      if (danoManaEl) danoManaEl.value = '';
      if (danoSanidadeEl) danoSanidadeEl.value = '';
      if (typeof window.updateInlineStatus === 'function') window.updateInlineStatus();
      if (typeof updateHeaderValues === 'function') updateHeaderValues(true);
      if (typeof window.showToast === 'function') window.showToast('Dano aplicado', 'damage');
    });

    document.getElementById('aplicar-cura-btn')?.addEventListener('click', () => {
      const curaVida = parseInt(document.getElementById('cura-vida')?.value || '0', 10) || 0;
      const curaMana = parseInt(document.getElementById('cura-mana')?.value || '0', 10) || 0;
      const curaSanidade = parseInt(document.getElementById('cura-sanidade')?.value || '0', 10) || 0;
      const vidaCur = document.getElementById('vida-current');
      const manaCur = document.getElementById('mana-current');
      const sanidadeCur = document.getElementById('sanidade-current');
      const vidaMax = parseInt(document.getElementById('vida-max')?.value || '0', 10);
      const manaMax = parseInt(document.getElementById('mana-max')?.value || '0', 10);
      const sanidadeMax = parseInt(document.getElementById('sanidade-max')?.value || '0', 10);
      if (vidaCur && curaVida > 0) {
        const v = parseInt(vidaCur.value, 10) || 0;
        vidaCur.value = String(Math.min(vidaMax, v + curaVida));
      }
      if (manaCur && curaMana > 0) {
        const m = parseInt(manaCur.value, 10) || 0;
        manaCur.value = String(Math.min(manaMax, m + curaMana));
      }
      if (sanidadeCur && curaSanidade > 0) {
        const s = parseInt(sanidadeCur.value, 10) || 0;
        sanidadeCur.value = String(Math.min(sanidadeMax, s + curaSanidade));
      }
      const curaVidaEl = document.getElementById('cura-vida');
      const curaManaEl = document.getElementById('cura-mana');
      const curaSanidadeEl = document.getElementById('cura-sanidade');
      if (curaVidaEl) curaVidaEl.value = '';
      if (curaManaEl) curaManaEl.value = '';
      if (curaSanidadeEl) curaSanidadeEl.value = '';
      if (typeof window.updateInlineStatus === 'function') window.updateInlineStatus();
      if (typeof updateHeaderValues === 'function') updateHeaderValues(true);
      if (typeof window.updateProgressBars === 'function') window.updateProgressBars();
      if (typeof window.showToast === 'function') window.showToast('Cura aplicada', 'healing');
    });

    // Escutar mudanÃ§as no Caminho para reduzir sanidade
    const caminhoSelect = document.getElementById('caminho');
    if (caminhoSelect) {
      caminhoSelect.dataset.wasEmpty = caminhoSelect.value.trim() ? 'false' : 'true';
      caminhoSelect.addEventListener('change', handleCaminhoChange);
    }

    // Escutar mudanÃ§as de status
    document.addEventListener('statusChanged', () => {
      updateHeaderValues();
    }, { passive: true });

    // Expor funÃ§Ã£o globalmente para outros componentes
    window.updateHeaderValues = updateHeaderValues;
  }
</script>

<style>
  .sheet-section {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 
      0 4px 20px rgba(0, 0, 0, 0.4),
      inset 0 1px 0 rgba(139, 76, 141, 0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .sheet-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(
      90deg,
      transparent,
      var(--color-accent-primary),
      transparent
    );
    opacity: 0.5;
  }

  .sheet-section:hover {
    border-color: var(--color-border-glow);
    box-shadow: 
      0 4px 20px rgba(0, 0, 0, 0.4),
      0 0 20px rgba(139, 76, 141, 0.2),
      inset 0 1px 0 rgba(139, 76, 141, 0.1);
  }

  .section-title {
    font-family: var(--font-heading);
    font-size: 2rem;
    color: var(--color-text-accent);
    margin-bottom: 1.5rem;
    text-align: center;
    position: relative;
    padding-bottom: 0.5rem;
  }

  .section-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 2px;
    background: var(--color-accent-primary);
    box-shadow: 0 0 8px rgba(139, 76, 141, 0.5);
  }

  .header-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .header-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .header-item label {
    font-family: var(--font-accent);
    color: var(--color-text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .hp-mana-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
  }

  .current-value {
    flex: 1 1 auto;
    min-width: 80px;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    padding: 0.75rem 0.5rem;
    color: var(--color-text-primary);
    font-family: var(--font-heading);
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    transition: all 0.3s ease;
    -moz-appearance: textfield;
  }

  .current-value::-webkit-outer-spin-button,
  .current-value::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .current-value:focus {
    outline: none;
    border-color: var(--color-accent-primary);
    box-shadow: 
      0 0 0 3px rgba(139, 76, 141, 0.2),
      0 0 12px rgba(139, 76, 141, 0.3);
  }

  .separator {
    color: var(--color-text-secondary);
    font-family: var(--font-heading);
    font-size: 1.1rem;
    font-weight: 600;
    opacity: 0.6;
    flex-shrink: 0;
  }

  .max-value {
    flex: 1 1 auto;
    min-width: 80px;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    padding: 0.75rem 0.5rem;
    color: var(--color-text-accent);
    font-family: var(--font-heading);
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    cursor: not-allowed;
    -moz-appearance: textfield;
  }

  .max-value::-webkit-outer-spin-button,
  .max-value::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .header-value {
    width: 100%;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    padding: 0.75rem 1rem;
    color: var(--color-text-accent);
    font-family: var(--font-heading);
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    cursor: not-allowed;
    -moz-appearance: textfield;
  }

  .header-value::-webkit-outer-spin-button,
  .header-value::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .header-input {
    width: 100%;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    padding: 0.75rem 1rem;
    color: var(--color-text-primary);
    font-family: var(--font-body);
    font-size: 1rem;
    transition: all 0.3s ease;
    -moz-appearance: textfield;
  }

  .header-input::-webkit-outer-spin-button,
  .header-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .header-input:focus {
    outline: none;
    border-color: var(--color-accent-primary);
    box-shadow: 
      0 0 0 3px rgba(139, 76, 141, 0.2),
      0 0 12px rgba(139, 76, 141, 0.3);
  }

  .header-input:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: var(--color-bg-primary);
  }

  .header-select {
    width: 100%;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    padding: 0.75rem 1rem;
    color: var(--color-text-primary);
    font-family: var(--font-body);
    font-size: 1rem;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .header-select:focus {
    outline: none;
    border-color: var(--color-accent-primary);
    box-shadow: 
      0 0 0 3px rgba(139, 76, 141, 0.2),
      0 0 12px rgba(139, 76, 141, 0.3);
  }

  .header-select option {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
  }

  .header-item-label-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .temp-value-small {
    width: 50px;
    background: rgba(139, 76, 141, 0.1);
    border: 1px solid rgba(139, 76, 141, 0.3);
    border-radius: 4px;
    padding: 0.2rem 0.35rem;
    color: var(--color-text-accent);
    font-family: var(--font-body);
    font-size: 0.7rem;
    text-align: center;
    transition: all 0.3s ease;
    -moz-appearance: textfield;
    opacity: 0.7;
    flex-shrink: 0;
  }

  .temp-value-small::-webkit-outer-spin-button,
  .temp-value-small::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .temp-value-small:focus {
    outline: none;
    border-color: var(--color-accent-primary);
    opacity: 1;
    box-shadow: 0 0 8px rgba(139, 76, 141, 0.3);
  }

  .temp-value-small::placeholder {
    color: var(--color-text-secondary);
    opacity: 0.5;
  }

  .bonus-inputs-row {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: flex-end;
  }

  .bonus-input-group {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    align-items: flex-start;
  }

  .bonus-input-label {
    font-size: 0.6rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.03em;
    white-space: nowrap;
    opacity: 0.9;
  }

  .temp-value-small.extra {
    opacity: 0.85;
  }

  .sanity-item {
    min-width: 200px;
  }

  .sanity-buttons-row {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
  }

  .sanity-test-btn {
    flex: 1;
    min-width: 44px;
    padding: 0.35rem 0.5rem;
    background: rgba(139, 76, 141, 0.2);
    border: 1px solid var(--color-accent-primary);
    border-radius: 4px;
    color: var(--color-text-accent);
    font-family: var(--font-body);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .sanity-test-btn:hover {
    background: rgba(139, 76, 141, 0.35);
    box-shadow: 0 0 10px rgba(139, 76, 141, 0.4);
  }

  .sanity-popup-btn {
    width: 44px;
    height: 36px;
    min-width: 44px;
    padding: 0;
    background: rgba(139, 76, 141, 0.2);
    border: 1px solid var(--color-accent-primary);
    border-radius: 4px;
    color: var(--color-text-accent);
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .sanity-popup-btn:hover {
    background: rgba(139, 76, 141, 0.35);
    box-shadow: 0 0 10px rgba(139, 76, 141, 0.4);
  }

  .nd-damage-heal-row {
    grid-column: 1 / -1;
    display: flex;
    flex-wrap: nowrap;
    align-items: flex-end;
    gap: 1.5rem;
    min-width: 0;
  }

  @media (max-width: 900px) {
    .nd-damage-heal-row {
      flex-wrap: wrap;
    }
  }

  .nd-projeteis-block {
    flex: 0 0 auto;
    min-width: 140px;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .nd-projeteis-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .cobertura-btns {
    display: flex;
    gap: 0.25rem;
  }

  .cobertura-btn {
    width: 28px;
    height: 28px;
    min-width: 28px;
    padding: 0;
    border: 1px solid var(--color-border);
    background: var(--color-bg-tertiary);
    color: var(--color-text-secondary);
    border-radius: 4px;
    font-family: var(--font-body);
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .cobertura-btn:hover {
    border-color: var(--color-accent-primary);
    color: var(--color-text-accent);
  }

  .cobertura-btn.active {
    background: rgba(139, 76, 141, 0.3);
    border-color: var(--color-accent-primary);
    color: var(--color-text-accent);
  }

  .damage-heal-block {
    flex: 0 0 auto;
    min-width: 180px;
  }

  .damage-calc-item {
    min-width: 220px;
  }

  .damage-calc-label {
    font-size: 0.85rem !important;
    margin-bottom: 0.35rem;
  }

  .damage-calc-inline-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    align-items: center;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .damage-calc-inline-item {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    min-width: 55px;
  }

  .damage-calc-inline-item label {
    font-size: 0.7rem;
    opacity: 0.9;
  }

  .damage-input-inline {
    width: 42px;
    padding: 0.4rem 0.3rem;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-text-primary);
    font-family: var(--font-body);
    font-size: 0.9rem;
    text-align: center;
    -moz-appearance: textfield;
  }

  .damage-input-inline::-webkit-outer-spin-button,
  .damage-input-inline::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .damage-input-inline:focus {
    outline: none;
    border-color: var(--color-accent-primary);
    box-shadow: 0 0 6px rgba(139, 76, 141, 0.3);
  }

  .aplicar-dano-btn-inline {
    padding: 0.4rem 0.9rem;
    background: linear-gradient(135deg, rgba(139, 76, 76, 0.3), rgba(139, 76, 76, 0.2));
    border: 1px solid rgba(139, 76, 76, 0.5);
    border-radius: 6px;
    color: #ff9999;
    font-family: var(--font-body);
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    align-self: flex-end;
  }

  .aplicar-dano-btn-inline:hover {
    background: linear-gradient(135deg, rgba(139, 76, 76, 0.4), rgba(139, 76, 76, 0.3));
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(139, 76, 76, 0.3);
  }

  .heal-label { margin-top: 0.75rem; }
  .heal-grid { margin-top: 0.25rem; }
  .heal-input-inline {
    width: 42px;
    padding: 0.4rem 0.3rem;
    background: var(--color-bg-tertiary);
    border: 1px solid rgba(76, 175, 80, 0.5);
    border-radius: 4px;
    color: var(--color-text-primary);
    font-family: var(--font-body);
    font-size: 0.9rem;
    text-align: center;
    -moz-appearance: textfield;
  }
  .heal-input-inline::-webkit-outer-spin-button,
  .heal-input-inline::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .heal-input-inline:focus {
    outline: none;
    border-color: #4caf50;
    box-shadow: 0 0 6px rgba(76, 175, 80, 0.3);
  }
  .aplicar-cura-btn-inline {
    padding: 0.4rem 0.9rem;
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.2));
    border: 1px solid rgba(76, 175, 80, 0.6);
    border-radius: 6px;
    color: #a5d6a7;
    font-family: var(--font-body);
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    align-self: flex-end;
  }
  .aplicar-cura-btn-inline:hover {
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.4), rgba(76, 175, 80, 0.3));
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
  }

  .stat-progress-bar {
    height: 4px;
    background: var(--color-bg-tertiary);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 0.35rem;
  }

  .stat-progress-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  .stat-progress-vida { background: linear-gradient(90deg, #c75c5c, #4caf50); }
  .stat-progress-mana { background: linear-gradient(90deg, #5c7cc7, var(--color-accent-primary)); }
  .stat-progress-sanidade { background: linear-gradient(90deg, #c7a85c, #8b7d4c); }

  .rest-buttons-section {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .rest-buttons-title {
    font-family: var(--font-accent);
    font-size: 1rem;
    color: var(--color-text-secondary);
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .rest-conditions-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.75rem;
  }

  .rest-buttons-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .conditions-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    font-family: var(--font-body);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
  }

  .conditions-btn:hover {
    border-color: var(--color-accent-primary);
    background: rgba(139, 76, 141, 0.15);
    color: var(--color-text-accent);
  }

  .conditions-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10002;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .conditions-popup[data-open="true"] {
    display: flex;
  }

  .conditions-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
  }

  .conditions-content {
    position: relative;
    background: var(--color-bg-secondary);
    border: 2px solid var(--color-accent-primary);
    border-radius: 16px;
    max-width: 480px;
    width: 100%;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5), 0 0 60px rgba(139, 76, 141, 0.3);
  }

  .conditions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--color-border);
    background: var(--color-bg-tertiary);
    border-radius: 14px 14px 0 0;
  }

  .conditions-header h3 {
    font-family: var(--font-heading);
    font-size: 1.2rem;
    color: var(--color-text-accent);
    margin: 0;
  }

  .conditions-header button {
    width: 32px;
    height: 32px;
    border: 1px solid var(--color-border);
    background: var(--color-bg-primary);
    color: var(--color-text-secondary);
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .conditions-header button:hover {
    border-color: var(--color-accent-primary);
    color: var(--color-text-accent);
  }

  .conditions-body {
    padding: 1rem 1.5rem;
    overflow-y: auto;
    flex: 1;
  }

  .conditions-desc {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    margin-bottom: 1rem;
    line-height: 1.5;
  }

  .conditions-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .condition-check-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
  }

  .condition-check-item input {
    flex-shrink: 0;
  }

  .condition-check-item label {
    flex: 1;
    font-family: var(--font-body);
    font-size: 0.9rem;
    cursor: pointer;
  }

  .condition-check-item .cond-desc {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    margin-top: 0.2rem;
  }

  .rest-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    font-family: var(--font-body);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
  }

  .rest-btn:hover {
    border-color: var(--color-accent-primary);
    background: rgba(139, 76, 141, 0.15);
    color: var(--color-text-accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 76, 141, 0.2);
  }

  .rest-ruim { border-left: 3px solid #8b4c4c; }
  .rest-mediano { border-left: 3px solid #8b7d4c; }
  .rest-bom { border-left: 3px solid #4c8b5e; }
  .rest-magico { border-left: 3px solid var(--color-accent-primary); }

  .movement-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .movement-base {
    flex: 1;
  }

  .movement-extra {
    width: 60px;
    background: rgba(139, 76, 141, 0.1);
    border: 1px solid rgba(139, 76, 141, 0.3);
    border-radius: 4px;
    padding: 0.5rem;
    color: var(--color-text-accent);
    font-family: var(--font-body);
    font-size: 0.9rem;
    text-align: center;
    transition: all 0.3s ease;
    -moz-appearance: textfield;
    opacity: 0.8;
  }

  .movement-extra::-webkit-outer-spin-button,
  .movement-extra::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .movement-extra:focus {
    outline: none;
    border-color: var(--color-accent-primary);
    opacity: 1;
    box-shadow: 0 0 8px rgba(139, 76, 141, 0.3);
  }

  .movement-extra::placeholder {
    color: var(--color-text-secondary);
    opacity: 0.5;
  }

  .status-container-inline {
    display: none;
    flex-direction: column;
    align-items: stretch;
    gap: 0.75rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
    border-top: 1px solid var(--color-border);
    flex-wrap: wrap;
  }

  .status-label-inline {
    font-family: var(--font-accent);
    color: var(--color-text-secondary);
    font-size: 0.85rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .status-badge {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-family: var(--font-body);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .status-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .status-icon {
    font-size: 1.5rem;
    line-height: 1;
  }

  .status-text {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .status-text strong {
    font-size: 0.95rem;
    font-weight: 600;
  }

  .status-description {
    font-size: 0.75rem;
    opacity: 0.8;
    font-weight: 400;
  }

  .status-badge.status-machucado {
    background: linear-gradient(135deg, rgba(139, 76, 76, 0.25), rgba(139, 76, 76, 0.15));
    border: 2px solid rgba(139, 76, 76, 0.5);
    color: #ff9999;
  }

  .status-badge.status-morrendo {
    background: linear-gradient(135deg, rgba(139, 76, 76, 0.35), rgba(139, 76, 76, 0.25));
    border: 2px solid rgba(255, 85, 85, 0.7);
    color: #ff5555;
    animation: pulse-red 2s infinite;
  }

  @keyframes pulse-red {
    0%, 100% { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 0 10px rgba(255, 85, 85, 0.3); }
    50% { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 0 20px rgba(255, 85, 85, 0.6); }
  }

  .status-badge.status-insano {
    background: linear-gradient(135deg, rgba(139, 76, 141, 0.25), rgba(139, 76, 141, 0.15));
    border: 2px solid rgba(139, 76, 141, 0.5);
    color: #e6b3e6;
  }

  .status-badge.status-condition {
    background: linear-gradient(135deg, rgba(139, 76, 141, 0.2), rgba(139, 76, 141, 0.1));
    border: 2px solid rgba(139, 76, 141, 0.4);
    color: var(--color-text-accent);
  }

  .death-saves-container {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .death-saves-title {
    font-family: var(--font-heading);
    font-size: 1.3rem;
    color: var(--color-text-accent);
    margin-bottom: 1rem;
    text-align: center;
  }

  .death-saves-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
  }

  .death-saves-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
  }

  .death-saves-label {
    font-family: var(--font-accent);
    font-size: 0.9rem;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .death-saves-checkboxes {
    display: flex;
    gap: 1rem;
  }

  .death-save-checkbox-label {
    width: 40px;
    height: 40px;
    border: 2px solid var(--color-border);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--color-bg-tertiary);
  }

  .death-save-checkbox-label:hover {
    border-color: var(--color-accent-primary);
    background: rgba(139, 76, 141, 0.1);
  }

  .death-save-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--color-accent-primary);
  }

  .death-save-checkbox[data-type="success"]:checked,
  .death-save-checkbox-label:has(.death-save-checkbox[data-type="success"]:checked) {
    border-color: #4c8b7d;
    background: rgba(76, 139, 125, 0.2);
  }

  .death-save-checkbox[data-type="failure"]:checked,
  .death-save-checkbox-label:has(.death-save-checkbox[data-type="failure"]:checked) {
    border-color: #8b4c4c;
    background: rgba(139, 76, 76, 0.2);
  }

  .section-title {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
    position: relative;
    padding: 1rem 0;
  }

  .section-title-text {
    font-family: var(--font-heading);
    font-size: 2.5rem;
    color: var(--color-text-accent);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 700;
    text-shadow: 
      0 0 20px rgba(139, 76, 141, 0.5),
      0 2px 10px rgba(0, 0, 0, 0.5);
    position: relative;
    z-index: 1;
  }

  .section-title-decoration {
    position: absolute;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(
      90deg,
      transparent,
      var(--color-accent-primary) 20%,
      var(--color-accent-primary) 80%,
      transparent
    );
    box-shadow: 
      0 0 10px rgba(139, 76, 141, 0.8),
      0 0 20px rgba(139, 76, 141, 0.4);
    opacity: 0.8;
    transform: scaleX(0.8);
  }

  .section-title-decoration::before,
  .section-title-decoration::after {
    content: '';
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    border: 2px solid var(--color-accent-primary);
    border-radius: 50%;
    box-shadow: 
      0 0 10px rgba(139, 76, 141, 0.8),
      inset 0 0 10px rgba(139, 76, 141, 0.3);
  }

  .section-title-decoration::before {
    left: 10%;
    background: radial-gradient(circle, var(--color-accent-primary) 30%, transparent 70%);
  }

  .section-title-decoration::after {
    right: 10%;
    background: radial-gradient(circle, var(--color-accent-primary) 30%, transparent 70%);
  }

  @media (max-width: 768px) {
    .sheet-section {
      padding: 1.5rem;
    }

    .section-title-text {
      font-size: 1.8rem;
    }

    .header-grid {
      grid-template-columns: 1fr;
    }

    .death-saves-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
  }
</style>
