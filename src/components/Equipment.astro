---
---

<section class="sheet-section equipment">
  <h2 class="section-title">
    <span class="section-title-text">Equipamentos</span>
    <span class="section-title-decoration"></span>
  </h2>
  <div class="equipment-grid">
    <div class="equipment-column">
      <div class="equipment-subsection-title">
        <h3>Armas</h3>
      </div>
      <div class="weapons-header">
        <span class="equipment-header-label" title="Nome da arma">Nome da arma</span>
        <span class="equipment-header-label" title="Tipo">Tipo</span>
        <span class="equipment-header-label" title="Dano">Dano</span>
        <span class="equipment-header-label" title="Descrição">Descrição</span>
      </div>
      <div id="weapons-list" class="equipment-list">
        <!-- Armamentos serão adicionados dinamicamente -->
      </div>
      <button class="btn-add" type="button" id="add-weapon-btn">+ Adicionar Arma</button>
    </div>
    <div class="equipment-column">
      <div class="equipment-subsection-title">
        <h3>Itens</h3>
        <div class="weight-display" id="weight-display">
          <span class="weight-label">Peso:</span>
          <span class="weight-value" id="weight-current">0</span>
          <span class="weight-separator">/</span>
          <span class="weight-value" id="weight-max">0</span>
        </div>
      </div>
      <div class="items-header">
        <span class="equipment-header-label" title="Nome do item">Nome do item</span>
        <span class="equipment-header-label" title="Descrição">Descrição</span>
        <span class="equipment-header-label" title="Peso">Peso</span>
      </div>
      <div id="items-list" class="equipment-list">
        <!-- Itens serão adicionados dinamicamente -->
      </div>
      <button class="btn-add" type="button" id="add-item-btn">+ Adicionar Item</button>
    </div>
  </div>
</section>

<script type="module">
  let equipmentIdCounter = 0;

  // Tipos de arma
  const weaponTypes = [
    { value: 'branca', label: 'Arma branca' },
    { value: 'fogo', label: 'Arma de Fogo' },
    { value: 'magica', label: 'Arma mágica' },
  ];

  // Opções de peso (1-9)
  const weightOptions = Array.from({ length: 9 }, (_, i) => i + 1);

  // Função para obter valor de atributo
  function getAttributeValue(attributeId) {
    const input = document.getElementById(attributeId);
    if (!input) return 0;
    return parseInt(input.value || '0');
  }

  // Função para calcular peso máximo (Brutalidade / 2)
  function getMaxWeight() {
    const brutalidade = getAttributeValue('brutalidade');
    return Math.floor(brutalidade / 2);
  }

  // Função para calcular peso atual dos itens
  function getCurrentWeight() {
    const items = document.querySelectorAll('.item-weight');
    let total = 0;
    items.forEach((item) => {
      const weight = parseInt(item.value) || 0;
      total += weight;
    });
    return total;
  }

  // Função para atualizar display de peso
  function updateWeightDisplay() {
    const currentWeight = getCurrentWeight();
    const maxWeight = getMaxWeight();
    
    const currentEl = document.getElementById('weight-current');
    const maxEl = document.getElementById('weight-max');
    
    if (currentEl) {
      currentEl.textContent = currentWeight.toString();
      // Mudar cor se sobrecarregado
      if (currentWeight > maxWeight && maxWeight > 0) {
        currentEl.style.color = '#cc7d7d'; // Vermelho claro
      } else {
        currentEl.style.color = ''; // Voltar ao padrão
      }
    }
    if (maxEl) {
      maxEl.textContent = maxWeight.toString();
    }
    
    // Disparar evento para atualizar movimento no Header
    document.dispatchEvent(new CustomEvent('weightChanged', { 
      detail: { current: currentWeight, max: maxWeight } 
    }));
  }

  function createWeapon() {
    const container = document.getElementById('weapons-list');
    if (!container) return;

    const id = `weapon-${equipmentIdCounter++}`;
    const weaponDiv = document.createElement('div');
    weaponDiv.className = 'equipment-row';
    weaponDiv.id = id;
    
    weaponDiv.innerHTML = `
      <div class="equipment-name-input">
        <input 
          type="text" 
          placeholder="Nome da arma" 
          class="equipment-name-input-field"
        />
      </div>
      <div class="equipment-type-select">
        <select class="equipment-type">
          ${weaponTypes.map(type => 
            `<option value="${type.value}">${type.label}</option>`
          ).join('')}
        </select>
      </div>
      <div class="equipment-damage-input">
        <input 
          type="text" 
          placeholder="Dano" 
          class="equipment-damage-input-field"
        />
      </div>
      <div class="equipment-description-input">
        <textarea 
          placeholder="Descrição" 
          rows="2" 
          class="equipment-description-field"
        ></textarea>
      </div>
      <button class="btn-remove" type="button" title="Remover arma">✕</button>
    `;

    const removeBtn = weaponDiv.querySelector('.btn-remove');
    if (removeBtn) {
      removeBtn.addEventListener('click', () => {
        weaponDiv.remove();
      });
    }

    container.appendChild(weaponDiv);
  }

  function createItem() {
    const container = document.getElementById('items-list');
    if (!container) return;

    const id = `item-${equipmentIdCounter++}`;
    const itemDiv = document.createElement('div');
    itemDiv.className = 'equipment-row';
    itemDiv.id = id;
    
    itemDiv.innerHTML = `
      <div class="equipment-name-input">
        <input 
          type="text" 
          placeholder="Nome do item" 
          class="equipment-name-input-field"
        />
      </div>
      <div class="equipment-description-input">
        <textarea 
          placeholder="Descrição" 
          rows="2" 
          class="equipment-description-field"
        ></textarea>
      </div>
      <div class="equipment-weight-select">
        <select class="item-weight">
          ${weightOptions.map(weight => 
            `<option value="${weight}">${weight}</option>`
          ).join('')}
        </select>
      </div>
      <button class="btn-remove" type="button" title="Remover item">✕</button>
    `;

    const removeBtn = itemDiv.querySelector('.btn-remove');
    const weightSelect = itemDiv.querySelector('.item-weight');
    
    if (removeBtn) {
      removeBtn.addEventListener('click', () => {
        itemDiv.remove();
        updateWeightDisplay();
      });
    }

    if (weightSelect) {
      weightSelect.addEventListener('change', () => {
        updateWeightDisplay();
      });
    }

    container.appendChild(itemDiv);
    updateWeightDisplay();
  }

  // Inicializar event listeners quando o DOM estiver pronto
  document.addEventListener('DOMContentLoaded', () => {
    const addWeaponBtn = document.getElementById('add-weapon-btn');
    const addItemBtn = document.getElementById('add-item-btn');

    if (addWeaponBtn) {
      addWeaponBtn.addEventListener('click', () => createWeapon());
    }

    if (addItemBtn) {
      addItemBtn.addEventListener('click', () => createItem());
    }

    // Atualizar peso quando atributo mudar
    function initializeWeightListener() {
      if (window.equipmentWeightListenerInitialized) return;
      window.equipmentWeightListenerInitialized = true;

      document.addEventListener('change', (e) => {
        const target = e.target;
        if (target && target.id === 'brutalidade') {
          updateWeightDisplay();
        }
      }, { passive: true, capture: true });

      document.addEventListener('input', (e) => {
        const target = e.target;
        if (target && target.id === 'brutalidade') {
          updateWeightDisplay();
        }
      }, { passive: true, capture: true });
    }

    // Inicializar display de peso
    requestAnimationFrame(() => {
      updateWeightDisplay();
      initializeWeightListener();
    });
  });

  // Tornar funções disponíveis globalmente (para compatibilidade com SaveLoad)
  window.createWeapon = createWeapon;
  window.createItem = createItem;
  window.updateWeightDisplay = updateWeightDisplay;
</script>

<style is:global>
  .equipment-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
  }

  .equipment-column {
    display: flex;
    flex-direction: column;
  }

  .equipment-subsection-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    gap: 1rem;
  }

  .equipment-subsection-title h3 {
    font-family: var(--font-accent);
    color: var(--color-text-accent);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0;
    opacity: 0.8;
  }

  .weight-display {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-family: var(--font-accent);
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  .weight-label {
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.8;
  }

  .weight-value {
    color: var(--color-text-accent);
    font-weight: 600;
    font-size: 0.85rem;
  }

  .weight-separator {
    color: var(--color-text-secondary);
    opacity: 0.6;
  }

  .weapons-header,
  .items-header {
    display: grid;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    margin-bottom: 0.5rem;
    align-items: center;
  }

  .weapons-header {
    grid-template-columns: 1fr 140px 100px 1fr 40px;
  }

  .items-header {
    grid-template-columns: 1fr 1fr 80px 40px;
  }

  .equipment-header-label {
    font-family: var(--font-accent);
    color: var(--color-text-accent);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: help;
    opacity: 0.8;
    text-align: left;
  }

  .equipment-header-label:nth-child(2),
  .equipment-header-label:nth-child(3),
  .equipment-header-label:nth-child(4) {
    text-align: center;
  }

  .equipment-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
    min-height: 100px;
    max-height: 600px;
    overflow-y: auto;
    padding-right: 0.5rem;
  }

  .equipment-list::-webkit-scrollbar {
    width: 6px;
  }

  .equipment-list::-webkit-scrollbar-track {
    background: var(--color-bg-primary);
    border-radius: 3px;
  }

  .equipment-list::-webkit-scrollbar-thumb {
    background: var(--color-accent-primary);
    border-radius: 3px;
  }

  .equipment-list::-webkit-scrollbar-thumb:hover {
    background: var(--color-accent-glow);
  }

  .equipment-row {
    display: grid;
    gap: 0.75rem;
    align-items: center;
    padding: 0.5rem 0.75rem;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    transition: all 0.3s ease;
    position: relative;
  }

  .equipment-row:hover {
    border-color: var(--color-border-glow);
    box-shadow: 
      0 4px 20px rgba(0, 0, 0, 0.4),
      0 0 20px rgba(139, 76, 141, 0.2),
      inset 0 1px 0 rgba(139, 76, 141, 0.1);
  }

  #weapons-list .equipment-row {
    grid-template-columns: 1fr 140px 100px 1fr 40px;
  }

  #items-list .equipment-row {
    grid-template-columns: 1fr 1fr 80px 40px;
  }

  .equipment-name-input {
    display: flex;
    align-items: center;
  }

  .equipment-name-input-field {
    width: 100%;
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.4rem 0.5rem;
    color: var(--color-text-primary);
    font-family: var(--font-body);
    font-size: 0.9rem;
    font-weight: 500;
  }

  .equipment-name-input-field:focus {
    outline: none;
    border-color: var(--color-accent-primary);
    box-shadow: 0 0 5px rgba(139, 76, 141, 0.3);
  }

  .equipment-type-select,
  .equipment-weight-select {
    display: flex;
    align-items: center;
  }

  .equipment-type,
  .item-weight {
    width: 100%;
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.4rem 0.5rem;
    color: var(--color-text-primary);
    font-family: var(--font-body);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .equipment-type:focus,
  .item-weight:focus {
    outline: none;
    border-color: var(--color-accent-primary);
    box-shadow: 
      0 0 0 3px rgba(139, 76, 141, 0.2),
      0 0 12px rgba(139, 76, 141, 0.3);
  }

  .equipment-damage-input {
    display: flex;
    align-items: center;
  }

  .equipment-damage-input-field {
    width: 100%;
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.4rem 0.5rem;
    color: var(--color-text-primary);
    font-family: var(--font-body);
    font-size: 0.9rem;
    text-align: center;
  }

  .equipment-damage-input-field:focus {
    outline: none;
    border-color: var(--color-accent-primary);
    box-shadow: 0 0 5px rgba(139, 76, 141, 0.3);
  }

  .equipment-description-input {
    display: flex;
    align-items: center;
  }

  .equipment-description-field {
    width: 100%;
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.4rem 0.5rem;
    color: var(--color-text-primary);
    font-family: var(--font-body);
    font-size: 0.85rem;
    resize: vertical;
    min-height: 40px;
  }

  .equipment-description-field:focus {
    outline: none;
    border-color: var(--color-accent-primary);
    box-shadow: 0 0 5px rgba(139, 76, 141, 0.3);
  }

  .btn-add {
    width: 100%;
    padding: 0.75rem;
    background: var(--color-bg-tertiary);
    border: 2px dashed var(--color-border);
    border-radius: 6px;
    color: var(--color-text-secondary);
    font-family: var(--font-accent);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .btn-add:hover {
    border-color: var(--color-accent-primary);
    color: var(--color-text-accent);
    background: rgba(139, 76, 141, 0.1);
    box-shadow: 0 0 10px rgba(139, 76, 141, 0.2);
  }

  .btn-remove {
    width: 28px;
    height: 28px;
    border: 1px solid var(--color-border);
    background: var(--color-bg-secondary);
    color: var(--color-text-secondary);
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .btn-remove:hover {
    background: #8b1a1a;
    border-color: #cc2a2a;
    color: var(--color-text-primary);
    transform: scale(1.1);
  }

  @media (max-width: 1024px) {
    .equipment-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .weapons-header,
    .items-header {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .equipment-row {
      grid-template-columns: 1fr !important;
      gap: 0.5rem;
    }
  }

  .section-title {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    position: relative;
    padding: 1rem 0;
  }

  .section-title-text {
    font-family: var(--font-heading);
    font-size: 2.5rem;
    color: var(--color-text-accent);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 700;
    text-shadow: 
      0 0 20px rgba(139, 76, 141, 0.5),
      0 2px 10px rgba(0, 0, 0, 0.5);
    position: relative;
    z-index: 1;
  }

  .section-title-decoration {
    position: absolute;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(
      90deg,
      transparent,
      var(--color-accent-primary) 20%,
      var(--color-accent-primary) 80%,
      transparent
    );
    box-shadow: 
      0 0 10px rgba(139, 76, 141, 0.8),
      0 0 20px rgba(139, 76, 141, 0.4);
    opacity: 0.8;
    transform: scaleX(0.8);
  }

  .section-title-decoration::before,
  .section-title-decoration::after {
    content: '';
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    border: 2px solid var(--color-accent-primary);
    border-radius: 50%;
    box-shadow: 
      0 0 10px rgba(139, 76, 141, 0.8),
      inset 0 0 10px rgba(139, 76, 141, 0.3);
  }

  .section-title-decoration::before {
    left: 10%;
    background: radial-gradient(circle, var(--color-accent-primary) 30%, transparent 70%);
  }

  .section-title-decoration::after {
    right: 10%;
    background: radial-gradient(circle, var(--color-accent-primary) 30%, transparent 70%);
  }

  @media (max-width: 768px) {
    .subsection-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .section-title-text {
      font-size: 1.8rem;
    }
  }
</style>
