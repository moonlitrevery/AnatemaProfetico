---
---

<section class="character-manager-section">
  <div class="character-manager-container">
    <div class="character-manager-header">
      <h2 class="character-manager-title">Gerenciar Fichas</h2>
      <button id="new-character-btn" class="new-character-btn" type="button">
        <span class="btn-icon">‚ûï</span>
        Nova Ficha
      </button>
    </div>
    
    <div id="characters-list" class="characters-list">
      <!-- Lista de fichas ser√° preenchida via JavaScript -->
    </div>
  </div>
</section>

<script type="module">
  const STORAGE_KEY = 'anathema-characters';
  const CURRENT_CHAR_KEY = 'anathema-current-character-id';

  function generateCharacterId() {
    return 'char-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
  }

  function getAllCharacters() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : {};
    } catch (error) {
      console.error('Erro ao carregar fichas:', error);
      return {};
    }
  }

  function saveAllCharacters(characters) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(characters));
    } catch (error) {
      console.error('Erro ao salvar fichas:', error);
      alert('Erro ao salvar fichas. O localStorage pode estar cheio.');
    }
  }

  function getCurrentCharacterId() {
    return localStorage.getItem(CURRENT_CHAR_KEY) || null;
  }

  function setCurrentCharacterId(id) {
    if (id) {
      localStorage.setItem(CURRENT_CHAR_KEY, id);
    } else {
      localStorage.removeItem(CURRENT_CHAR_KEY);
    }
  }

  // Usar a fun√ß√£o getAllCharacterData do SaveLoad se dispon√≠vel
  function getCharacterData() {
    // Tentar usar a fun√ß√£o global do SaveLoad
    if (window.getAllCharacterData) {
      return window.getAllCharacterData();
    }
    
    // Fallback: vers√£o simplificada
    const basicInfo = {
      playerName: document.getElementById('player-name')?.value || '',
      characterName: document.getElementById('character-name')?.value || '',
      age: document.getElementById('character-age')?.value || '',
      profession: document.getElementById('character-profession')?.value || '',
      pronouns: Array.from(document.querySelectorAll('.pronoun-checkbox:checked')).map(cb => cb.value),
      imageUrl: document.getElementById('character-image-url')?.value || '',
    };

    const nivelSelect = document.getElementById('nivel');
    const caminhoSelect = document.getElementById('caminho');
    
    const header = {
      caminho: caminhoSelect?.value || '',
      nivel: nivelSelect?.value || '0',
      prestigio: document.getElementById('prestigio')?.value || 'muito-baixo',
      vidaCurrent: document.getElementById('vida-current')?.value || '',
      vidaTemp: document.getElementById('vida-temp')?.value || '',
      manaCurrent: document.getElementById('mana-current')?.value || '',
      manaTemp: document.getElementById('mana-temp')?.value || '',
      sanidadeCurrent: document.getElementById('sanidade-current')?.value || '',
      sanidadeTemp: document.getElementById('sanidade-temp')?.value || '',
      movimentoExtra: document.getElementById('movimento-extra')?.value || '',
    };

    const attributes = {};
    ['brutalidade', 'destreza', 'compleicao', 'mente', 'sobrenatural'].forEach(id => {
      const input = document.getElementById(id);
      if (input) {
        const v = parseInt(input.value, 10);
        attributes[id] = Number.isNaN(v) ? 0 : v;
      }
    });

    const skills = [];
    document.querySelectorAll('.skill-row').forEach((row) => {
      const nameInput = row.querySelector('.skill-name');
      const nameStatic = row.querySelector('.skill-name-static');
      const valueInput = row.querySelector('.skill-value');
      const attrSelect = row.querySelector('.skill-attribute');
      const trainingSelect = row.querySelector('.skill-training');
      const skillId = row.getAttribute('data-skill-id');
      if (valueInput && attrSelect && skillId) {
        const name = nameInput?.value || nameStatic?.textContent || '';
        const isEditable = !!nameInput;
        const vv = parseInt(valueInput.value, 10);
        skills.push({
          name: name,
          attribute: attrSelect.value,
          value: Number.isNaN(vv) ? 0 : vv,
          training: trainingSelect?.value || 'none',
          editable: isEditable,
          id: skillId,
        });
      }
    });

    const equipment = { weapons: [], items: [] };
    document.querySelectorAll('#weapons-list .equipment-row').forEach((row) => {
      const nameInput = row.querySelector('.equipment-name-input-field');
      const typeSelect = row.querySelector('.equipment-type');
      const damageInput = row.querySelector('.equipment-damage-input-field');
      const descInput = row.querySelector('.equipment-description-field');
      if (nameInput) {
        equipment.weapons.push({
          name: nameInput.value || '',
          type: typeSelect?.value || 'arma-branca',
          damage: damageInput?.value || '',
          description: descInput?.value || '',
        });
      }
    });

    document.querySelectorAll('#items-list .equipment-row').forEach((row) => {
      const nameInput = row.querySelector('.equipment-name-input-field');
      const weightInput = row.querySelector('.equipment-weight-input-field');
      const descInput = row.querySelector('.equipment-description-field');
      if (nameInput) {
        equipment.items.push({
          name: nameInput.value || '',
          weight: weightInput?.value || '1',
          description: descInput?.value || '',
        });
      }
    });

    const abilities = [];
    document.querySelectorAll('.ability-row').forEach((row) => {
      const nameInput = row.querySelector('.ability-name-input');
      const typeSelect = row.querySelector('.ability-type-select');
      const sequenceInput = row.querySelector('.ability-sequence-input');
      const costInput = row.querySelector('.ability-cost-input');
      const descInput = row.querySelector('.ability-description-input');
      if (nameInput) {
        abilities.push({
          name: nameInput.value || '',
          type: typeSelect?.value || 'passiva',
          sequence: sequenceInput?.value || '',
          cost: costInput?.value || '',
          description: descInput?.value || '',
        });
      }
    });

    const notes = {
      sobre: document.getElementById('notes-sobre')?.value || '',
      sessoes: document.getElementById('notes-sessoes')?.value || '',
      aliados: document.getElementById('notes-aliados')?.value || '',
      inimigos: document.getElementById('notes-inimigos')?.value || '',
      extras: document.getElementById('notes-extras')?.value || '',
    };

    return {
      basicInfo,
      header,
      attributes,
      skills,
      equipment,
      abilities,
      notes,
    };
  }

  function renderCharactersList() {
    const characters = getAllCharacters();
    const currentId = getCurrentCharacterId();
    const listContainer = document.getElementById('characters-list');
    
    if (!listContainer) return;

    if (Object.keys(characters).length === 0) {
      listContainer.innerHTML = `
        <div class="no-characters">
          <p>Nenhuma ficha salva ainda.</p>
          <p class="hint">Crie uma nova ficha para come√ßar!</p>
        </div>
      `;
      return;
    }

    const charactersArray = Object.entries(characters)
      .map(([id, data]) => ({ id, ...data }))
      .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

    listContainer.innerHTML = charactersArray.map(char => `
      <div class="character-item ${char.id === currentId ? 'active' : ''}" data-character-id="${char.id}">
        <div class="character-info">
          <h3 class="character-name">${char.name || 'Ficha sem nome'}</h3>
          <p class="character-meta">
            ${char.data?.basicInfo?.characterName || 'Sem personagem'} ‚Ä¢ 
            N√≠vel ${char.data?.header?.nivel || '0'} ‚Ä¢ 
            ${new Date(char.timestamp).toLocaleDateString('pt-BR')}
          </p>
        </div>
        <div class="character-actions">
          <button class="action-btn-small load-btn" data-id="${char.id}" title="Carregar">
            üìÇ
          </button>
          <button class="action-btn-small overwrite-btn" data-id="${char.id}" title="Sobrescrever">
            üíæ
          </button>
          <button class="action-btn-small rename-btn" data-id="${char.id}" title="Renomear">
            ‚úèÔ∏è
          </button>
          <button class="action-btn-small delete-btn" data-id="${char.id}" title="Deletar">
            üóëÔ∏è
          </button>
        </div>
      </div>
    `).join('');

    // Event listeners
    listContainer.querySelectorAll('.load-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        loadCharacter(id);
      });
    });

    listContainer.querySelectorAll('.overwrite-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        overwriteCharacter(id);
      });
    });

    listContainer.querySelectorAll('.rename-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        renameCharacter(id);
      });
    });

    listContainer.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        deleteCharacter(id);
      });
    });
  }
  
  function overwriteCharacter(id) {
    if (!confirm('Tem certeza que deseja sobrescrever esta ficha com os dados atuais da ficha?')) {
      return;
    }
    
    const characters = getAllCharacters();
    const character = characters[id];
    
    if (!character) {
      alert('Ficha n√£o encontrada!');
      return;
    }
    
    // Obter dados atuais da ficha
    const currentData = getCharacterData();
    
    // Sobrescrever dados
    characters[id].data = currentData;
    characters[id].timestamp = Date.now();
    
    // Atualizar nome se o nome do personagem mudou
    const charName = currentData.basicInfo?.characterName || 'Ficha sem nome';
    if (charName && charName !== characters[id].name) {
      characters[id].name = charName;
    }
    
    saveAllCharacters(characters);
    renderCharactersList();
    
    alert(`Ficha "${character.name}" sobrescrita com sucesso!`);
  }

  function saveCurrentCharacter(name = null) {
    const characters = getAllCharacters();
    let currentId = getCurrentCharacterId();
    
    // Se n√£o h√° ID atual, criar novo
    if (!currentId) {
      currentId = generateCharacterId();
      setCurrentCharacterId(currentId);
    }
    
    const characterData = getCharacterData();
    const characterName = name || characterData.basicInfo?.characterName || 'Ficha sem nome';
    
    // Atualizar ou criar ficha
    characters[currentId] = {
      id: currentId,
      name: characterName,
      data: characterData,
      timestamp: Date.now(),
    };
    
    saveAllCharacters(characters);
    renderCharactersList();
    
    return currentId;
  }
  
  // Exportar fun√ß√£o para uso externo
  window.saveCurrentCharacter = saveCurrentCharacter;
  window.renderCharactersList = renderCharactersList;

  function loadCharacter(id) {
    const characters = getAllCharacters();
    const character = characters[id];
    
    if (!character) {
      alert('Ficha n√£o encontrada!');
      return;
    }

    // Salvar ficha atual antes de carregar nova
    const currentId = getCurrentCharacterId();
    if (currentId && characters[currentId]) {
      saveCurrentCharacter();
    }

    // Usar a fun√ß√£o loadCharacterData do SaveLoad se dispon√≠vel
    const data = character.data;
    
    if (window.loadCharacterData) {
      window.loadCharacterData(data);
    } else {
      // Aguardar um pouco para garantir que SaveLoad foi carregado
      setTimeout(() => {
        if (window.loadCharacterData) {
          window.loadCharacterData(data);
        } else {
          console.error('loadCharacterData n√£o dispon√≠vel');
          alert('Erro ao carregar ficha. Recarregue a p√°gina.');
        }
      }, 500);
    }
    
    setCurrentCharacterId(id);
    renderCharactersList();
    
    // Atualizar valores calculados
    setTimeout(() => {
      if (window.updateHeaderValues) window.updateHeaderValues();
      if (window.updateInlineStatus) window.updateInlineStatus();
    }, 300);
    
    alert(`Ficha "${character.name}" carregada com sucesso!`);
  }

  function renameCharacter(id) {
    const characters = getAllCharacters();
    const character = characters[id];
    
    if (!character) return;
    
    const newName = prompt('Digite o novo nome da ficha:', character.name || 'Ficha sem nome');
    
    if (newName && newName.trim()) {
      characters[id].name = newName.trim();
      saveAllCharacters(characters);
      renderCharactersList();
    }
  }

  function deleteCharacter(id) {
    if (!confirm('Tem certeza que deseja deletar esta ficha? Esta a√ß√£o n√£o pode ser desfeita.')) {
      return;
    }
    
    const characters = getAllCharacters();
    delete characters[id];
    saveAllCharacters(characters);
    
    if (getCurrentCharacterId() === id) {
      setCurrentCharacterId(null);
    }
    
    renderCharactersList();
  }

  document.addEventListener('DOMContentLoaded', () => {
    const newCharBtn = document.getElementById('new-character-btn');
    
    if (newCharBtn) {
      newCharBtn.addEventListener('click', () => {
        // Salvar ficha atual antes de criar nova (se houver ID ativo)
        const currentId = getCurrentCharacterId();
        if (currentId) {
          try {
            saveCurrentCharacter();
          } catch (e) {
            console.warn('Erro ao salvar ficha atual:', e);
          }
        }
        
        // Limpar campos da ficha primeiro
        const clearBtn = document.getElementById('clear-btn');
        if (clearBtn) {
          // Simular clique no bot√£o clear (que j√° limpa o ID)
          clearBtn.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
        } else {
          // Fallback: limpar ID manualmente
          setCurrentCharacterId(null);
        }
        
        // Aguardar um pouco para garantir que a limpeza foi feita
        setTimeout(() => {
          const name = prompt('Digite um nome para a nova ficha:', 'Nova Ficha');
          if (name && name.trim()) {
            // Criar nova ficha com novo ID √∫nico
            let newId = generateCharacterId();
            
            // Garantir que o ID seja √∫nico
            const characters = getAllCharacters();
            while (characters[newId]) {
              newId = generateCharacterId();
            }
            
            // Definir o novo ID como ativo
            setCurrentCharacterId(newId);
            
            // Salvar ficha vazia com o nome
            const characterData = getCharacterData();
            characters[newId] = {
              id: newId,
              name: name.trim(),
              data: characterData,
              timestamp: Date.now(),
            };
            saveAllCharacters(characters);
            renderCharactersList();
            
            alert(`Ficha "${name.trim()}" criada com sucesso!`);
          }
        }, 100);
      });
    }
    
    renderCharactersList();
  });
</script>

<style>
  .character-manager-section {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .character-manager-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .character-manager-title {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    color: var(--color-text-accent);
    margin: 0;
  }

  .new-character-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-glow));
    border: 2px solid var(--color-accent-primary);
    border-radius: 8px;
    color: white;
    font-family: var(--font-body);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .new-character-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(139, 76, 141, 0.4);
  }

  .characters-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .character-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background: var(--color-bg-tertiary);
    border: 2px solid var(--color-border);
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .character-item:hover {
    border-color: var(--color-accent-primary);
    background: rgba(139, 76, 141, 0.05);
  }

  .character-item.active {
    border-color: var(--color-accent-primary);
    background: rgba(139, 76, 141, 0.1);
    box-shadow: 0 0 15px rgba(139, 76, 141, 0.2);
  }

  .character-info {
    flex: 1;
  }

  .character-name {
    font-family: var(--font-heading);
    font-size: 1.2rem;
    color: var(--color-text-accent);
    margin: 0 0 0.5rem 0;
  }

  .character-meta {
    font-family: var(--font-body);
    font-size: 0.9rem;
    color: var(--color-text-secondary);
    margin: 0;
  }

  .character-actions {
    display: flex;
    gap: 0.5rem;
  }

  .action-btn-small {
    width: 36px;
    height: 36px;
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .action-btn-small:hover {
    border-color: var(--color-accent-primary);
    background: rgba(139, 76, 141, 0.1);
    transform: scale(1.1);
  }

  .no-characters {
    text-align: center;
    padding: 2rem;
    color: var(--color-text-secondary);
  }

  .no-characters .hint {
    font-style: italic;
    margin-top: 0.5rem;
  }

  @media (max-width: 768px) {
    .character-manager-header {
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }

    .character-item {
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }

    .character-actions {
      justify-content: flex-end;
    }
  }
</style>

